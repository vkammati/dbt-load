{{
  config(
    materialized = 'incremental',
    unique_key=['MANDT', 'VBELN', 'POSNR'],
    on_schema_change = 'ignore',
    partition_by=['partition_key'],
    post_hook="DELETE FROM {{ this }} WHERE OPFLAG = 'D'",
    tags=["SD-EUH-D"]
    )
}}

with
source as (
    select MANDT,VBELN,POSNR,MATNR,MATWA,PMATN,CHARG,MATKL,ARKTX,PSTYV,POSAR,LFREL,FKREL,UEPOS,
    GRPOS,ABGRU,PRODH,ZWERT,ZMENG,ZIEME,UMZIZ,UMZIN,MEINS,SMENG,ABLFZ,ABDAT,ABSFZ,POSEX,KDMAT,
    KBVER,KEVER,VKGRU,VKAUS,GRKOR,FMENG,UEBTK,UEBTO,UNTTO,FAKSP,ATPKZ,RKFKF,SPART,GSBER,NETWR,
    WAERK,ANTLF,KZTLF,CHSPL,KWMENG,LSMENG,KBMENG,KLMENG,VRKME,UMVKZ,UMVKN,BRGEW,NTGEW,GEWEI,
    VOLUM,VOLEH,VBELV,POSNV,VGBEL,VGPOS,VOREF,UPFLU,ERLRE,LPRIO,WERKS,LGORT,VSTEL,ROUTE,
    STKEY,STDAT,STLNR,STPOS,AWAHR,ERDAT,ERNAM,ERZET,TAXM1,TAXM2,TAXM3,TAXM4,TAXM5,TAXM6,TAXM7,
    TAXM8,TAXM9,VBEAF,VBEAV,VGREF,NETPR,KPEIN,KMEIN,SHKZG,SKTOF,MTVFP,SUMBD,KONDM,KTGRM,BONUS,
    PROVG,EANNR,PRSOK,BWTAR,BWTEX,XCHPF,XCHAR,LFMNG,STAFO,WAVWR,KZWI1,KZWI2,KZWI3,KZWI4,KZWI5,
    KZWI6,STCUR,AEDAT,EAN11,FIXMG,PRCTR,MVGR1,MVGR2,MVGR3,MVGR4,MVGR5,KMPMG,SUGRD,SOBKZ,VPZUO,
    PAOBJNR,PS_PSP_PNR,AUFNR,VPMAT,VPWRK,PRBME,UMREF,KNTTP,KZVBR,SERNR,OBJNR,ABGRS,BEDAE,CMPRE,
    CMTFG,CMPNT,CMKUA,CUOBJ,CUOBJ_CH,CEPOK,KOUPD,SERAIL,ANZSN,NACHL,MAGRV,MPROK,VGTYP,PROSA,UEPVW,
    KALNR,KLVAR,SPOSN,KOWRR,STADAT,EXART,PREFE,KNUMH,CLINT,CHMVS,STLTY,STLKN,STPOZ,STMAN,ZSCHL_K,
    KALSM_K,KALVAR,KOSCH,UPMAT,UKONM,MFRGR,PLAVO,KANNR,CMPRE_FLT,ABFOR,ABGES,J_1BCFOP,J_1BTAXLW1,
    J_1BTAXLW2,J_1BTXSDC,WKTNR,WKTPS,SKOPF,KZBWS,WGRU1,WGRU2,KNUMA_PI,KNUMA_AG,KZFME,LSTANR,TECHS,
    MWSBP,BERID,PCTRF,LOGSYS_EXT,J_1BTAXLW3,J_1BTAXLW4,J_1BTAXLW5,STOCKLOC,SLOCTYPE,MSR_RET_REASON,
    MSR_REFUND_CODE,MSR_APPROV_BLOCK,NRAB_KNUMH,TRMRISK_RELEVANT,SGT_RCAT,HANDOVERLOC,HANDOVERDATE,
    HANDOVERTIME,TC_AUT_DET,MANUAL_TC_REASON,FISCAL_INCENTIVE,TAX_SUBJECT_ST,FISCAL_INCENTIVE_ID,
    SPCSTO,"/BEV1/SRFUND",ZSTIREFNO,ZSTIREFITEM,ZOID_PLANT,AUFPL_OLC,APLZL_OLC,FERC_IND,KOSTL,FONDS,
    FISTL,FKBER,GRANT_NBR,IUID_RELEVANT,OID_EXTBOL,OID_MISCDL,OIPLANTD,OIBYPASS,OIEDOK,CMETH,
    OITAXFROM,OIHANTYP,OITAXGRP,OITAXTO,OICERTF1,OIOILCON,OIEDBAL,OIPRICIE,OIINEX,OIEDBALM,OIDRC,
    OIC_DRCTRY,OIC_DRCREG,OIMETIND,OIWAP,OISLF,OIPSDRC,OIPIPEVAL,OIC_LIFNR,OIC_DCITYC,OIC_DCOUNC,
    OIC_DREGIO,OIC_DLAND1,OIC_OCITYC,OIC_OCOUNC,OIC_OREGIO,OIC_OLAND1,OIC_PORGIN,OIC_PDESTN,
    OIC_PTRIP,OIC_PBATCH,OIC_MOT,OIC_AORGIN,OIC_ADESTN,OIC_TRUCKN,OIA_BASELO,OIEXGNUM,OIEXGTYP,
    OIFEETOT,OIFEEDT,OINETCYC,OICONTNR,OIC_KMPOS,OIFEECH,OIH_LICTP,OIH_LICIN,OIH_LCFOL,OIH_FOLQTY,
    OISBREL,OIBASPROD,OIDMSG_PRD,OIDMSG_QTY,OIDMSG_UOM,OIDMSG_DAT,OIDMSG_TRM,OIDMSG_SHP,OIGNRULE,
    OID_SHIP,OIBWTAR_IM,OIHANTYP_IM,OITAXGRP_IM,OITAXFROM_IM,OITAXTO_IM,OIEDBAL_IM,OIEDBALM_IM,
    OIPRICIE_IM,OIBWTAR_EX,OIHANTYP_EX,OITAXGRP_EX,OITAXFROM_EX,OITAXTO_EX,OIEDBAL_EX,OIEDBALM_EX,
    OIPRICIE_EX,OIINEX_EX,OICERTF1_EX,OIH_LICTP_EX,OIH_LICIN_EX,OIH_LCFOL_EX,OIH_FOLQTY_EX,
    OIHTAXRCP_EX,OIHNOTWERKS,OIHNOTLGORT,OIHCOTDISCH,OIU_MP_NO,OIU_WL_NO,OIU_WC_NO,PO_QUAN,PO_UNIT,
    PRS_OBJNR,PRS_SD_SPSNR,PRS_WORK_PERIOD,PARGB,AUFPL_OAA,APLZL_OAA,"/DS1/FTLFG","/DS1/FTLQT",
    "/DS1/FTLUM","/DS1/RETFG","/DS1/WRK02","/DS1/FUTDPFIX",_DATAAGING,REVACC_REFID,REVACC_REFTYPE,
    GLO_LOG_REF1_IT,FSH_SEASON_YEAR,FSH_SEASON,FSH_COLLECTION,FSH_THEME,FSH_CRSD,FSH_SEAREF,
    FSH_CANDATE,FSH_PSM_PFM_SPLIT,FSH_VAS_REL,FSH_VAS_PRNT_ID,FSH_TRANSACTION,FSH_ITEM_GROUP,
    FSH_ITEM,FSH_VASREF,FSH_GRID_COND_REC,FSH_PQR_UEPOS,BUDGET_PD,MILL_SE_GPOSN,TAS,BETC,MOD_ALLOW,
    CANCEL_ALLOW,PAY_METHOD,BPN,REP_FREQ,FMFGUS_KEY,WRF_CHARSTC1,WRF_CHARSTC2,WRF_CHARSTC3,ARSNUM,
    ARSPOS,WTYSC_CLMITEM,"/DS1/ICPFG","/DS1/FPQT","/DS1/FPUM",
    ingested_at, LAST_ACTION_CD, LAST_DTM, SYSTEM_ID, Z_SLT_PRODH, ZSDOCITM, ZSORGITM, ZSREFITM, ZVBELN_ID,ZHANDL_TYP_ID, ZSPART_ID, ZMATNR_ID
    , "HANA" as _dbt_source_relation, '' as AESID, '' as AERUNID, '' as AEDATTM, '' as OPFLAG,
    '' as AERECNO, '' as SESSION_CREATION_DATE, '' as SESSION_CREATION_TIME,RIGHT(VBELN,{{var("partition_var")}}) AS partition_key
    from {{ source('raw-ds-dbt','VBAP') }}
    union
    select MANDT,VBELN,POSNR,MATNR,MATWA,PMATN,CHARG,MATKL,ARKTX,PSTYV,POSAR,LFREL,FKREL,UEPOS,
    GRPOS,ABGRU,PRODH,ZWERT,ZMENG,ZIEME,UMZIZ,UMZIN,MEINS,SMENG,ABLFZ,ABDAT,ABSFZ,POSEX,KDMAT,
    KBVER,KEVER,VKGRU,VKAUS,GRKOR,FMENG,UEBTK,UEBTO,UNTTO,FAKSP,ATPKZ,RKFKF,SPART,GSBER,NETWR,
    WAERK,ANTLF,KZTLF,CHSPL,KWMENG,LSMENG,KBMENG,KLMENG,VRKME,UMVKZ,UMVKN,BRGEW,NTGEW,GEWEI,
    VOLUM,VOLEH,VBELV,POSNV,VGBEL,VGPOS,VOREF,UPFLU,ERLRE,LPRIO,WERKS,LGORT,VSTEL,ROUTE,
    STKEY,STDAT,STLNR,STPOS,AWAHR,ERDAT,ERNAM,ERZET,TAXM1,TAXM2,TAXM3,TAXM4,TAXM5,TAXM6,TAXM7,
    TAXM8,TAXM9,VBEAF,VBEAV,VGREF,NETPR,KPEIN,KMEIN,SHKZG,SKTOF,MTVFP,SUMBD,KONDM,KTGRM,BONUS,
    PROVG,EANNR,PRSOK,BWTAR,BWTEX,XCHPF,XCHAR,LFMNG,STAFO,WAVWR,KZWI1,KZWI2,KZWI3,KZWI4,KZWI5,
    KZWI6,STCUR,AEDAT,EAN11,FIXMG,PRCTR,MVGR1,MVGR2,MVGR3,MVGR4,MVGR5,KMPMG,SUGRD,SOBKZ,VPZUO,
    PAOBJNR,PS_PSP_PNR,AUFNR,VPMAT,VPWRK,PRBME,UMREF,KNTTP,KZVBR,SERNR,OBJNR,ABGRS,BEDAE,CMPRE,
    CMTFG,CMPNT,CMKUA,CUOBJ,CUOBJ_CH,CEPOK,KOUPD,SERAIL,ANZSN,NACHL,MAGRV,MPROK,VGTYP,PROSA,UEPVW,
    KALNR,KLVAR,SPOSN,KOWRR,STADAT,EXART,PREFE,KNUMH,CLINT,CHMVS,STLTY,STLKN,STPOZ,STMAN,ZSCHL_K,
    KALSM_K,KALVAR,KOSCH,UPMAT,UKONM,MFRGR,PLAVO,KANNR,CMPRE_FLT,ABFOR,ABGES,J_1BCFOP,J_1BTAXLW1,
    J_1BTAXLW2,J_1BTXSDC,WKTNR,WKTPS,SKOPF,KZBWS,WGRU1,WGRU2,KNUMA_PI,KNUMA_AG,KZFME,LSTANR,TECHS,
    MWSBP,BERID,PCTRF,LOGSYS_EXT,J_1BTAXLW3,J_1BTAXLW4,J_1BTAXLW5,STOCKLOC,SLOCTYPE,MSR_RET_REASON,
    MSR_REFUND_CODE,MSR_APPROV_BLOCK,NRAB_KNUMH,TRMRISK_RELEVANT,SGT_RCAT,HANDOVERLOC,HANDOVERDATE,
    HANDOVERTIME,TC_AUT_DET,MANUAL_TC_REASON,FISCAL_INCENTIVE,TAX_SUBJECT_ST,FISCAL_INCENTIVE_ID,
    SPCSTO,"/BEV1/SRFUND",ZSTIREFNO,ZSTIREFITEM,ZOID_PLANT,AUFPL_OLC,APLZL_OLC,FERC_IND,KOSTL,FONDS,
    FISTL,FKBER,GRANT_NBR,IUID_RELEVANT,OID_EXTBOL,OID_MISCDL,OIPLANTD,OIBYPASS,OIEDOK,CMETH,
    OITAXFROM,OIHANTYP,OITAXGRP,OITAXTO,OICERTF1,OIOILCON,OIEDBAL,OIPRICIE,OIINEX,OIEDBALM,OIDRC,
    OIC_DRCTRY,OIC_DRCREG,OIMETIND,OIWAP,OISLF,OIPSDRC,OIPIPEVAL,OIC_LIFNR,OIC_DCITYC,OIC_DCOUNC,
    OIC_DREGIO,OIC_DLAND1,OIC_OCITYC,OIC_OCOUNC,OIC_OREGIO,OIC_OLAND1,OIC_PORGIN,OIC_PDESTN,
    OIC_PTRIP,OIC_PBATCH,OIC_MOT,OIC_AORGIN,OIC_ADESTN,OIC_TRUCKN,OIA_BASELO,OIEXGNUM,OIEXGTYP,
    OIFEETOT,OIFEEDT,OINETCYC,OICONTNR,OIC_KMPOS,OIFEECH,OIH_LICTP,OIH_LICIN,OIH_LCFOL,OIH_FOLQTY,
    OISBREL,OIBASPROD,OIDMSG_PRD,OIDMSG_QTY,OIDMSG_UOM,OIDMSG_DAT,OIDMSG_TRM,OIDMSG_SHP,OIGNRULE,
    OID_SHIP,OIBWTAR_IM,OIHANTYP_IM,OITAXGRP_IM,OITAXFROM_IM,OITAXTO_IM,OIEDBAL_IM,OIEDBALM_IM,
    OIPRICIE_IM,OIBWTAR_EX,OIHANTYP_EX,OITAXGRP_EX,OITAXFROM_EX,OITAXTO_EX,OIEDBAL_EX,OIEDBALM_EX,
    OIPRICIE_EX,OIINEX_EX,OICERTF1_EX,OIH_LICTP_EX,OIH_LICIN_EX,OIH_LCFOL_EX,OIH_FOLQTY_EX,
    OIHTAXRCP_EX,OIHNOTWERKS,OIHNOTLGORT,OIHCOTDISCH,OIU_MP_NO,OIU_WL_NO,OIU_WC_NO,PO_QUAN,PO_UNIT,
    PRS_OBJNR,PRS_SD_SPSNR,PRS_WORK_PERIOD,PARGB,AUFPL_OAA,APLZL_OAA,"/DS1/FTLFG","/DS1/FTLQT",
    "/DS1/FTLUM","/DS1/RETFG","/DS1/WRK02","/DS1/FUTDPFIX",_DATAAGING,REVACC_REFID,REVACC_REFTYPE,
    GLO_LOG_REF1_IT,FSH_SEASON_YEAR,FSH_SEASON,FSH_COLLECTION,FSH_THEME,FSH_CRSD,FSH_SEAREF,
    FSH_CANDATE,FSH_PSM_PFM_SPLIT,FSH_VAS_REL,FSH_VAS_PRNT_ID,FSH_TRANSACTION,FSH_ITEM_GROUP,
    FSH_ITEM,FSH_VASREF,FSH_GRID_COND_REC,FSH_PQR_UEPOS,BUDGET_PD,MILL_SE_GPOSN,TAS,BETC,MOD_ALLOW,
    CANCEL_ALLOW,PAY_METHOD,BPN,REP_FREQ,FMFGUS_KEY,WRF_CHARSTC1,WRF_CHARSTC2,WRF_CHARSTC3,ARSNUM,
    ARSPOS,WTYSC_CLMITEM,"/DS1/ICPFG","/DS1/FPQT","/DS1/FPUM",
    ingested_at,  '' as LAST_ACTION_CD, '' as LAST_DTM, '' as SYSTEM_ID,  '' as Z_SLT_PRODH,
    '' as ZSDOCITM,  '' as ZSORGITM,  '' as ZSREFITM,  '' as ZVBELN_ID,  '' as ZHANDL_TYP_ID,
    '' as ZSPART_ID,  '' as ZMATNR_ID, "AECORSOFT" AS _dbt_source_relation, AESID, AERUNID,
    AEDATTM, OPFLAG, AERECNO, SESSION_CREATION_DATE, SESSION_CREATION_TIME, RIGHT(VBELN,{{var("partition_var")}}) AS partition_key
    from {{ source('raw-ds-dbt','AECORSOFT_VBAP')}}
    where AEDATTM is not null
)

select *
from source
